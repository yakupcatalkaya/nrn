

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LinearMechanism &mdash; NEURON  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="StateTransitionEvent" href="ste.html" />
    <link rel="prev" title="KSChan" href="kschan.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> NEURON
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Building:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cmake_doc/index.html">NEURON CMake Build</a></li>
</ul>
<p class="caption"><span class="caption-text">User documentation:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../py_doc/index.html">NEURON Python documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">NEURON HOC documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../index.html#quick-links">Quick Links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#basic-programming">Basic Programming</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html#model-specification">Model Specification</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../guitools.html">Model Specification GUI Tools</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../programmatic.html">Programmatic Model Specification</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="topology.html">Topology</a></li>
<li class="toctree-l4"><a class="reference internal" href="ions.html">Ions</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="mechanisms.html">Dynamics (Channels, etc…)</a></li>
<li class="toctree-l4"><a class="reference internal" href="rxd.html">Basic Reaction-Diffusion</a></li>
<li class="toctree-l4"><a class="reference internal" href="network.html">Networks</a></li>
<li class="toctree-l4"><a class="reference internal" href="electrod.html">Electrode</a></li>
<li class="toctree-l4"><a class="reference internal" href="mechtype.html">MechanismType</a></li>
<li class="toctree-l4"><a class="reference internal" href="obsoletestimuli.html">Obsolete Stimuli</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#simulation-control">Simulation Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#visualization">Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#analysis">Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Python tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rxd-tutorials/index.html">Python RXD tutorials</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scm/index.html">NEURON SCM and Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/index.html">NEURON Development topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doxygen.html">C/C++ API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">NEURON</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">NEURON HOC documentation</a> &raquo;</li>
        
          <li><a href="../programmatic.html">Programmatic Model Specification</a> &raquo;</li>
        
          <li><a href="mechanisms.html">Dynamics (Channels, etc…)</a> &raquo;</li>
        
      <li>LinearMechanism</li>
    
    
<li class="wy-breadcrumbs-aside">
    
        <a href="/nrn/py_doc/modelspec/programmatic/linmod.html" > Switch to Python</a>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/new_doc/modelspec/programmatic/linmod.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
</li>

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p><dl class="docutils"><dt><a href="#LinearMechanism" title="Link to this definition">LinearMechanism</a></dt><dd></dd></dl></p><div class="section" id="linearmechanism">
<span id="linmod"></span><h1>LinearMechanism<a class="headerlink" href="#linearmechanism" title="Permalink to this headline">¶</a></h1>
<dl class="py class">
<dt id="LinearMechanism">
<em class="property">class </em><code class="descname">LinearMechanism</code><a class="headerlink" href="#LinearMechanism" title="Permalink to this definition">¶</a></dt>
<dd><dl class="docutils">
<dt>Syntax:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">lm</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">LinearMechanism(c,</span> <span class="pre">g,</span> <span class="pre">y,</span> <span class="pre">[y0],</span> <span class="pre">b)</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">section</span> <span class="pre">lm</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">LinearMechanism(c,</span> <span class="pre">g,</span> <span class="pre">y,</span> <span class="pre">[y0],</span> <span class="pre">b,</span> <span class="pre">x)</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">lm</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">LinearMechanism(c,</span> <span class="pre">g,</span> <span class="pre">y,</span> <span class="pre">[y0],</span> <span class="pre">b,</span> <span class="pre">sl,</span> <span class="pre">xvec,</span> <span class="pre">[layervec])</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">lm</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">LinearMechanism(pycallable,</span> <span class="pre">c,</span> <span class="pre">g,</span> <span class="pre">y,</span> <span class="pre">...)</span></code></p>
</dd>
<dt>Description:</dt><dd><p>Adds linear equations to the tree matrix current balance equations.
I.e. the equations are solved
simultaneously with the current balance equations.
These equations may modify current balance equations and involve
membrane potentials as dependent variables.</p>
<p>The equations added are of the differential-algebraic form
<span class="math notranslate nohighlight">\(c \frac{dy}{dt} + g y = b\)</span>
with initial conditions specified by the optional y0 vector argument.
c and g must be square matrices of the same rank as the y and b vectors.
The implementation is more efficient if c is a sparse matrix since
at every time step c*y/dt must be computed.</p>
<p>When a LinearMechanism is created, all the potentially non-zero elements
for the c and g matrices must be actually non-zero so that
the mathematical topology of the matrices is known in advance.
After creation, elements can be set to 0 if desired.</p>
<p>The arguments after the b vector specify which voltages and current
balance equations are coupled to this system. The scalar form, x, with
a currently accessed section means that the first equation
is added to the current balance equation at this location and the first
dependent variable is a copy of the membrane potential. If the
system is coupled to more than one location, then  sl must be a SectionList
and xvec a Vector of relative positions (0 … 1) specifying the
locations. In this case, the first xvec.size equations are added to the
corresponding current balance equations and the first xvec.size dependent
y variables are copies of the membrane potentials at this location.
If the optional layervec argument is present then the values must be
0, 1, or 2 (or up to however many layers are defined in <code class="file docutils literal notranslate"><span class="pre">src/nrnoc/options.h</span></code>)
0 refers to the internal potential (equal to the membrane potential when
the extracellular mechanism is not inserted), and higher numbers refer
to the <code class="docutils literal notranslate"><span class="pre">vext[layer-1]</span></code> layer (or ground if the extracellular mechanism is
not inserted).</p>
<p>If some y variables correspond to membrane potential, the corresponding
initial values in the y0 vector are ignored and the initial values come
from the values of v during the normal <a class="reference internal" href="../../../py_doc/simctrl/programmatic.html#finitialize" title="finitialize"><code class="xref py py-func docutils literal notranslate"><span class="pre">finitialize()</span></code></a> call. If you change
the value of v after finitialize, then you should also change the
corresponding y values if the linear system involves derivatives of v.</p>
<p>Note that current balance equations of sections when 0 &lt; x &lt; 1 have dimensions
of milliamp/cm2 and positive terms are outward. Thus
c elements involving voltages in mV
have dimensions of 1000 <span class="math notranslate nohighlight">\(\mathrm{\mu{}F/cm^2}\)</span> (so a value of .001 corresponds to
1  <span class="math notranslate nohighlight">\(\mathrm{\mu{}F/cm^2}\)</span>), g elements have dimensions of <span class="math notranslate nohighlight">\(\mathrm{S/cm^2}\)</span>, and b elements have
dimensions of outward current in <span class="math notranslate nohighlight">\(\mathrm{milliamp/cm^2}\)</span>. The current balance
equations for the zero area nodes at the beginning and end
of a section (x = 0 and x = 1) have terms with the dimensions of
nanoamps. Thus c elements involving voltages in mV have dimensions
of nF and g elements have dimensions of <span class="math notranslate nohighlight">\(\mathrm{\mu{}S}\)</span>.</p>
<p>The existence of one or more LinearMechanism switches the gaussian elimination
solver to the general sparse linear equation solver written by
Kenneth S. Kundert and available from
<a class="reference external" href="http://www.netlib.org/sparse/index.html">http://www.netlib.org/sparse/index.html</a>
Although, even with no added equations, the solving of m*x=b takes more
than twice as long as the original default solver, there is no restriction
to a tree topology.</p>
</dd>
</dl>
<p>Example:</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>load_file(&quot;nrngui.hoc&quot;)

create soma
soma { insert hh }

//ideal voltage clamp.
objref c, g, y, b, model
c = new Matrix(2,2,2) //sparse - no elements used
g = new Matrix(2,2)
y = new Vector(2) // y.x[1] is injected current
b = new Vector(2)
g.x[0][1] = -1
g.x[1][0] = 1
b.x[1] = 10 // voltage clamp level

soma model = new LinearMechanism(c, g, y, b, .5)

proc advance() {
    printf(&quot;t=%g v=%g y.x[1]=%g\n&quot;, t, soma.v(.5), y.x[1])
    fadvance()
}
run()
</pre></div>
</div>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Does not work with the CVODE integrator but does work with the
differential-algebraic solver IDA. Note that if the standard
run system is loaded, <code class="docutils literal notranslate"><span class="pre">cvode_active(1)</span></code> will automatically
choose the correct variable step integrator.
Does not allow changes to coupling locations.
Is not notified when matrices, vectors, or segments it depends on
disappear.</p>
</div>
<dl class="docutils">
<dt>Description (continued):</dt><dd>If the pycallable argument (A Python Callable object) is present
it is called just before the b Vector is used during a simulation. The
callable can change the elements of b and g (but do not introduce new
elements into g) as a function of time and states. It may be useful for
stability and performance to place the linearized part of b into g.
Consider the following pendulum.py with equations</dd>
</dl>
<p>Example:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\frac{d\theta}{dt} = \omega\]</div>
<div class="math notranslate nohighlight">
\[\frac{d\omega}{dt} = -\frac{g}{L} \sin(\theta) \text{ with } \frac{g}{L}=1\]</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neuron</span> <span class="kn">import</span> <span class="n">h</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span>

<span class="n">h</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s1">&#39;nrngui.hoc&#39;</span><span class="p">)</span>

<span class="n">cmat</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">ident</span><span class="p">()</span>

<span class="n">gmat</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">gmat</span><span class="o">.</span><span class="n">setval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y0</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
  <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">nlm</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">LinearMechanism</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">cmat</span><span class="p">,</span> <span class="n">gmat</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="n">dummy</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Section</span><span class="p">()</span>
<span class="n">trajec</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
<span class="n">tvec</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
<span class="n">trajec</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">_ref_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">tvec</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">_ref_t</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
<span class="n">h</span><span class="o">.</span><span class="n">tstop</span><span class="o">=</span><span class="mi">50</span>

<span class="k">def</span> <span class="nf">prun</span><span class="p">(</span><span class="n">theta0</span><span class="p">,</span> <span class="n">omega0</span><span class="p">):</span>
  <span class="n">graph</span><span class="o">.</span><span class="n">erase</span><span class="p">()</span>
  <span class="n">y0</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta0</span>
  <span class="n">y0</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">omega0</span>
  <span class="n">h</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
  <span class="n">trajec</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">tvec</span><span class="p">)</span>

<span class="n">h</span><span class="o">.</span><span class="n">dt</span> <span class="o">/=</span> <span class="mi">10</span>
<span class="n">h</span><span class="o">.</span><span class="n">cvode</span><span class="o">.</span><span class="n">atol</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">cvode_active</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">prun</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.9999</span><span class="p">)</span> <span class="c1"># 2.0001 will keep it rotating</span>
<span class="n">graph</span><span class="o">.</span><span class="n">exec_menu</span><span class="p">(</span><span class="s2">&quot;View = plot&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ste.html" class="btn btn-neutral float-right" title="StateTransitionEvent" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="kschan.html" class="btn btn-neutral float-left" title="KSChan" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Duke, Yale and the Blue Brain Project

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>